import fs from 'node:fs';
import path from 'node:path';

const projectRoot = path.resolve(process.cwd());
const publicDir = path.join(projectRoot, 'public');
const imagesRoot = path.join(publicDir, 'assets', 'images');

const IMAGE_EXTS = new Set(['.jpg', '.jpeg', '.png', '.webp']);

function walk(dir) {
    const entries = fs.readdirSync(dir, { withFileTypes: true });
    const results = [];
    for (const entry of entries) {
        const full = path.join(dir, entry.name);
        if (entry.isDirectory()) {
            results.push(...walk(full));
        } else if (entry.isFile()) {
            const ext = path.extname(entry.name).toLowerCase();
            if (IMAGE_EXTS.has(ext)) results.push(full);
        }
    }
    return results;
}

function toPublicPath(filePath) {
    const relToPublic = path.relative(publicDir, filePath).split(path.sep).join('/');
    return relToPublic;
}

// We keep the About section images in their own carousel and do NOT include them
// in the main Gallery section.
const EXCLUDED_SUBPATHS = ['/gallery/about-us/'];

const SHUFFLE_SEED = 'kozak-gallery-v1';

function xmur3(str) {
    let h = 1779033703 ^ str.length;
    for (let i = 0; i < str.length; i++) {
        h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
        h = (h << 13) | (h >>> 19);
    }
    return function () {
        h = Math.imul(h ^ (h >>> 16), 2246822507);
        h = Math.imul(h ^ (h >>> 13), 3266489909);
        h ^= h >>> 16;
        return h >>> 0;
    };
}

function mulberry32(a) {
    return function () {
        let t = (a += 0x6d2b79f5);
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
}

function shuffleDeterministic(list, seed) {
    const seedFn = xmur3(seed);
    const rand = mulberry32(seedFn());
    const arr = [...list];
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(rand() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

function categoryRank(p) {
    if (p.includes('/locations/')) return 0;
    if (p.includes('/packages/')) return 1;
    return 2;
}

function packageSortKey(p) {
    const folderMatch = p.match(/\/packages\/(\d+)-[^/]+\//);
    const imgMatch = p.match(/\/IMG-(\d+)\.(jpg|jpeg|png|webp)$/i);
    return {
        folder: folderMatch ? Number(folderMatch[1]) : Number.POSITIVE_INFINITY,
        img: imgMatch ? Number(imgMatch[1]) : Number.POSITIVE_INFINITY,
    };
}

function sortPaths(a, b) {
    const ra = categoryRank(a);
    const rb = categoryRank(b);
    if (ra !== rb) return ra - rb;

    if (ra === 2 && rb === 2) {
        const ka = packageSortKey(a);
        const kb = packageSortKey(b);
        if (ka.folder !== kb.folder) return ka.folder - kb.folder;
        if (ka.img !== kb.img) return ka.img - kb.img;
    }

    return a.localeCompare(b);
}

if (!fs.existsSync(imagesRoot)) {
    console.error(`Images folder not found: ${imagesRoot}`);
    process.exit(1);
}

const allFiles = walk(imagesRoot);
const allPublicPaths = allFiles
    .map(toPublicPath)
    .filter((p) => p.startsWith('assets/images/'))
    .filter((p) => !EXCLUDED_SUBPATHS.some((sub) => p.includes(sub)));

const combinedUnique = Array.from(new Set(allPublicPaths));
combinedUnique.sort(sortPaths);

// Option C: random order but stable across builds.
const finalList = shuffleDeterministic(combinedUnique, SHUFFLE_SEED);

const outFile = path.join(projectRoot, 'src', 'data', 'galleryImages.js');
const content = `// This file is auto-generated by scripts/generate-gallery-manifest.mjs
// Do not edit by hand.

export const GALLERY_IMAGES = ${JSON.stringify(finalList, null, 4)};
`;

fs.mkdirSync(path.dirname(outFile), { recursive: true });
fs.writeFileSync(outFile, content, 'utf8');

console.log(`Generated ${finalList.length} gallery images -> ${path.relative(projectRoot, outFile)}`);
