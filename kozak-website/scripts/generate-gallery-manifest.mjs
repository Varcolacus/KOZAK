import fs from 'node:fs';
import path from 'node:path';

const projectRoot = path.resolve(process.cwd());
const publicDir = path.join(projectRoot, 'public');
const imagesRoot = path.join(publicDir, 'assets', 'images');

const IMAGE_EXTS = new Set(['.jpg', '.jpeg', '.png', '.webp']);

function walk(dir) {
    const entries = fs.readdirSync(dir, { withFileTypes: true });
    const results = [];
    for (const entry of entries) {
        const full = path.join(dir, entry.name);
        if (entry.isDirectory()) {
            results.push(...walk(full));
        } else if (entry.isFile()) {
            const ext = path.extname(entry.name).toLowerCase();
            if (IMAGE_EXTS.has(ext)) results.push(full);
        }
    }
    return results;
}

function toPublicPath(filePath) {
    const relToPublic = path.relative(publicDir, filePath).split(path.sep).join('/');
    return relToPublic;
}

const pinnedAboutUs = [
    'assets/images/gallery/about-us/IMG-20251102-WA0003.jpg',
    'assets/images/gallery/about-us/IMG-20251102-WA0007.jpg',
    'assets/images/gallery/about-us/IMG-20251102-WA0004.jpg',
    'assets/images/gallery/about-us/IMG-20251102-WA0008.jpg',
    'assets/images/gallery/about-us/IMG-20251102-WA0005.jpg',
    'assets/images/gallery/about-us/IMG-20251102-WA0006.jpg',
];

function categoryRank(p) {
    if (p.includes('/gallery/about-us/')) return 0;
    if (p.includes('/locations/')) return 1;
    if (p.includes('/packages/')) return 2;
    return 3;
}

function packageSortKey(p) {
    const folderMatch = p.match(/\/packages\/(\d+)-[^/]+\//);
    const imgMatch = p.match(/\/IMG-(\d+)\.(jpg|jpeg|png|webp)$/i);
    return {
        folder: folderMatch ? Number(folderMatch[1]) : Number.POSITIVE_INFINITY,
        img: imgMatch ? Number(imgMatch[1]) : Number.POSITIVE_INFINITY,
    };
}

function sortPaths(a, b) {
    const ra = categoryRank(a);
    const rb = categoryRank(b);
    if (ra !== rb) return ra - rb;

    if (ra === 2 && rb === 2) {
        const ka = packageSortKey(a);
        const kb = packageSortKey(b);
        if (ka.folder !== kb.folder) return ka.folder - kb.folder;
        if (ka.img !== kb.img) return ka.img - kb.img;
    }

    return a.localeCompare(b);
}

if (!fs.existsSync(imagesRoot)) {
    console.error(`Images folder not found: ${imagesRoot}`);
    process.exit(1);
}

const allFiles = walk(imagesRoot);
const allPublicPaths = allFiles.map(toPublicPath).filter((p) => p.startsWith('assets/images/'));

const pinnedSet = new Set(pinnedAboutUs);
const rest = allPublicPaths.filter((p) => !pinnedSet.has(p)).sort(sortPaths);

const finalList = [...pinnedAboutUs, ...rest];

const outFile = path.join(projectRoot, 'src', 'data', 'galleryImages.js');
const content = `// This file is auto-generated by scripts/generate-gallery-manifest.mjs
// Do not edit by hand.

export const GALLERY_IMAGES = ${JSON.stringify(finalList, null, 4)};
`;

fs.mkdirSync(path.dirname(outFile), { recursive: true });
fs.writeFileSync(outFile, content, 'utf8');

console.log(`Generated ${finalList.length} gallery images -> ${path.relative(projectRoot, outFile)}`);
